{{#section "css"}}
<style>
.divider:after,
.divider:before {
  content: "";
  flex: 1;
  height: 1px;
  background: #eee;
}

/* Ô OTP ngắn */
#otp {
  max-width: 180px;
}

/* Nút send OTP khi disable */
.btn-otp-disabled {
  opacity: 0.6;
  pointer-events: none;
  transition: 0.3s;
}
</style>
{{/section}}


{{#section "js"}}
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!--Hàm sendOTP()-->
<script>
let otpCooldown = false;

async function sendOTP() {
  if (otpCooldown) return;

  const email = document.querySelector("#email").value.trim();
  const btn = document.querySelector("#btnSendOTP");

  if (!email) {
    Swal.fire({
      icon: "warning",
      title: "Missing Email",
      text: "Please enter your email first!"
    });
    return;
  }

  otpCooldown = true;
  btn.classList.add("btn-otp-disabled");
  btn.innerText = "Sending...";

  try {
    const res = await fetch("/accounts/send-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    const data = await res.json();

    if (data.success) {
      Swal.fire({
        icon: "success",
        title: "OTP Sent",
        text: data.message || "OTP sent successfully!"
      });
    } else {
      Swal.fire({
        icon: "error",
        title: "Failed",
        text: data.message || "Something went wrong."
      });
    }

  } catch (err) {
    Swal.fire({
      icon: "error",
      title: "Error",
      text: "Error sending OTP!"
    });
  }

  // Bắt đầu countdown 60s
  let timeLeft = 60;
  const countdown = setInterval(() => {
    btn.innerText = `Wait ${timeLeft}s`;
    timeLeft--;

    if (timeLeft < 0) {
      clearInterval(countdown);
      otpCooldown = false;
      btn.classList.remove("btn-otp-disabled");
      btn.innerText = "Send OTP";
    }
  }, 1000);
}
</script>


<!--Validation Information-->
<script>
    document.querySelector('#formSignUp').addEventListener('submit', function(e) {
    e.preventDefault();

    const fullName = document.querySelector('#fullName').value.trim();
    const address = document.querySelector('#address').value.trim();
    const email = document.querySelector('#email').value.trim();

    if (fullName.length === 0 || address.length === 0 || email.length === 0) {
        Swal.fire({
            title: 'Validation Error',
            text: 'Please enter all the required information.',
            icon: 'error'
        });
        return;
    }

    const password = document.querySelector('#password').value;
    const confirmPassword = document.querySelector('#confirmPassword').value;

    if (password.length < 8) {
        Swal.fire({
            title: 'Validation Error',
            text: 'Password must be at least 8 characters long.',
            icon: 'error'
        });
        return;
    }

    const specialCharRegex = /[!@#$%^&*(),.?":{}|<>]/;
    if (!specialCharRegex.test(password)) {
        Swal.fire({
            title: 'Validation Error',
            text: 'Password must contain at least one special character.',
            icon: 'error'
        });
        return;
    }

    if (password !== confirmPassword) {
        Swal.fire({
            title: 'Validation Error',
            text: 'Passwords do not match.',
            icon: 'error'
        });
        return;
    }

    // Nếu hợp lệ, submit form
    e.target.submit();
    });
</script>



<script>
    {{#if error}}
        Swal.fire({
            icon: 'error',
            title: 'error',
            text: "{{{error}}}"
        });
    {{/if}}

    {{#if success}}
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: "{{{success}}}"
        });
    {{/if}}
</script>




<script src="https://accounts.google.com/gsi/client?hl=en" async defer></script>
<script>
function handleCredentialResponse(response) {
    // response.credential là ID token do Google cấp
    fetch('/accounts/google-signin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: response.credential })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            // login thành công, redirect hoặc reload
            window.location.href = '/accounts/dashboard';
        } else {
            alert('Google login failed');
        }
    })
    .catch(err => console.error(err));
}

window.onload = function() {
    // Khởi tạo Google Sign-In
    google.accounts.id.initialize({
        client_id: '{{googleClientId}}', // lấy từ backend, truyền xuống template
        callback: handleCredentialResponse,
        locale: 'en' // buộc hiển thị tiếng Anh
    });

    // Render nút Google Sign-In
    google.accounts.id.renderButton(
        document.getElementById('googleSignInBtn'),
        {
            theme: 'outline',
            size: 'large',
            width: '100%',
            locale: 'en' // buộc hiển thị tiếng Anh
        }
    );

    // Optional: tự prompt đăng nhập khi load (false nếu không muốn)
    google.accounts.id.prompt(); 
};
</script>
{{/section}}

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card border-0 shadow-lg">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <i class="bi bi-person-plus text-primary" style="font-size: 3rem;"></i>
                    <h2 class="mt-3">Create an Account</h2>
                    <p class="text-muted">Register to start bidding</p>
                </div>

                <form method="POST" id="formSignUp">
                    <div class="mb-3">
                        <label for="fullName" class="form-label">Full name</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" id="fullName" name="fullName" 
                                  placeholder="Nguyen Van A" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                            <input type="text" class="form-control" id="address" name="address"
                                  placeholder="123 Example Street" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="email@example.com" required>
                        </div>
                        <small class="text-muted">Your email will be used to log in</small>
                    </div>

                    <!-- OTP Input -->
                    <div class="mb-3">
                        <label for="otp" class="form-label">Enter OTP</label>
                        <div class="input-group">
                            <input type="text" id="otp" name="otp" class="form-control" placeholder="123456" required>
                            <button type="button" class="btn btn-primary" id="btnSendOTP" onclick="sendOTP()">Send OTP</button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="password" name="password"required>
                        </div>
                        <small class="text-muted">At least 8 characters</small>
                    </div>

                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="g-recaptcha" data-sitekey={{RECAPTCHA_SITE_KEY}}></div>
                    </div>

                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-person-plus"></i> Sign Up
                        </button>
                    </div>

                    <div class="text-center mb-3">
                        <span class="text-muted">or sign up with</span>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div id="googleSignInBtn"></div>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-primary w-100">
                                <i class="bi bi-facebook"></i> Facebook
                            </button>
                        </div>
                    </div>

                    <hr>

                    <div class="text-center">
                        <p class="mb-0">
                            Already have an account?
                            <a href="/accounts/signin" class="text-decoration-none fw-bold">Log in now</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


