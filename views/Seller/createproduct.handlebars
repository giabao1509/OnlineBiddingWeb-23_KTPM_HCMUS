<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <h3 class="mb-0">
            <i class="bi bi-plus-circle text-primary me-2"></i>Create Auction Product
        </h3>
        <p class="text-muted">Fill in all required information to list your product</p>
    </div>
</div>

<form action="/seller/create_product" method="POST" enctype="multipart/form-data" id="productForm">
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle text-primary"></i> Basic Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Product Name -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            Product Name <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" name="title" required 
                               placeholder="e.g. iPhone 15 Pro Max 256GB - Official VN/A">
                        <small class="text-muted">
                            A clear and detailed title helps attract more buyers
                        </small>
                    </div>

                    <!-- Category -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                Parent Category <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" name="parentCategory" id="parentCategory" required>
                              <option value="">-- Select Parent --</option>
                              {{#each categories}}
                                <option value="{{id}}">{{cat_name}}</option>
                              {{/each}}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                Subcategory <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" name="subCategory" id="subCategory" required>
                              <option value="">-- Select Subcategory --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Images Upload -->
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-images text-success"></i> Product Images
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info py-2 px-3 mb-3">
                        <i class="bi bi-info-circle"></i>
                        <small>
                            At least 3 images are required. The first image will be used as the thumbnail.
                        </small>
                    </div>

                    <input type="file" class="form-control mb-3" name="images" id="imageInput" 
                           accept="image/*" multiple required>
                    
                    <!-- Image Preview -->
                    <div id="imagePreview" class="row g-2"></div>
                    
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-check-circle text-success"></i>
                        Uploaded: <span id="imageCount">0</span>/10 images
                    </small>
                </div>
            </div>

            <!-- Product Description -->
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text text-warning"></i> Product Description
                    </h5>
                </div>
                <div class="card-body">
                    <div id="editor" style="min-height: 300px; border: 1px solid #dee2e6; border-radius: 0.25rem;"></div>
                    <input type="hidden" name="description" id="descriptionInput">
                    <small class="text-muted d-block mt-2">
                        A detailed description helps buyers better understand your product
                    </small>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Pricing -->
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0">
                        <i class="bi bi-currency-dollar"></i> Pricing & Duration
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Start Price -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            Starting Price <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="startPrice" required 
                                   min="0" step="1000" placeholder="0">
                            <span class="input-group-text">VND</span>
                        </div>
                    </div>

                    <!-- Bid Step -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            Bid Increment <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="bidStep" required 
                                   min="1000" step="1000" placeholder="100000">
                            <span class="input-group-text">VND</span>
                        </div>
                        <small class="text-muted">
                            Each bid must increase by this amount
                        </small>
                    </div>

                    <!-- Buy Now Price -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            Buy Now Price <small class="text-muted">(Optional)</small>
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="buyNowPrice" 
                                   min="0" step="1000" placeholder="0">
                            <span class="input-group-text">VND</span>
                        </div>
                        <small class="text-muted">
                            Buyers can instantly purchase at this price
                        </small>
                    </div>

                    <hr>

                    <!-- Auction Duration -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            Auction Duration <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" name="duration" required>
                            <option value="">-- Select Duration --</option>
                            <option value="3">3 days</option>
                            <option value="5">5 days</option>
                            <option value="7">7 days (Recommended)</option>
                            <option value="10">10 days</option>
                            <option value="14">14 days</option>
                        </select>
                    </div>

                    <!-- Auto Extend -->
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="autoExtend" id="autoExtend" checked>
                        <label class="form-check-label" for="autoExtend">
                            <strong>Auto Extend</strong>
                        </label>
                    </div>
                    <small class="text-muted">
                        Automatically extend by 10 minutes if a bid is placed within the last 5 minutes
                    </small>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    <i class="bi bi-upload"></i> Publish Auction
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</form>

{{#section 'css'}}
<!-- Include Quill CSS & JS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
    .ql-editor {
        min-height: 250px;
    }
    
    .image-preview-item {
        position: relative;
    }
    
    .image-preview-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 0.25rem;
    }
    
    .image-preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
    }
    
    .image-preview-item .main-badge {
        position: absolute;
        top: 5px;
        left: 5px;
        background: rgba(13, 110, 253, 0.9);
        color: white;
        padding: 2px 8px;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
</style>
{{/section}}


{{#section 'js'}}
<script>
    // Initialize Quill Editor
    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Enter a detailed description of the product...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                ['link', 'image'],
                ['clean']
            ]
        }
    });

    // Form submit - get Quill content
    document.getElementById('productForm').addEventListener('submit', function(e) {
        syncFileInput();
        const description = quill.root.innerHTML;
        document.getElementById('descriptionInput').value = description;
    });

    // Image Upload Preview
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const imageCount = document.getElementById('imageCount');

    let selectedFiles = [];

    imageInput.addEventListener('change', function (e) {
        const files = Array.from(e.target.files);

        if (selectedFiles.length + files.length > 10) {
            alert('Chỉ được tải tối đa 10 ảnh!');
            imageInput.value = '';
            return;
        }

        files.forEach(file => selectedFiles.push(file));

        syncFileInput();
        renderImagePreview();
    });

    function removeImage(index) {
        selectedFiles.splice(index, 1);
        syncFileInput();
        renderImagePreview();
    }

    function syncFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        imageInput.files = dt.files;
    }

    function renderImagePreview() {
        imagePreview.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();

            reader.onload = function (e) {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-6 image-preview-item';

                col.innerHTML = `
                    <img src="${e.target.result}" class="shadow-sm">
                    ${index === 0 ? '<span class="main-badge">Ảnh chính</span>' : ''}
                    <button type="button" class="remove-btn" onclick="removeImage(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                `;

                imagePreview.appendChild(col);
            };

            reader.readAsDataURL(file);
        });

        updateImageCount();
    }

    function updateImageCount() {
        imageCount.textContent = selectedFiles.length;

        if (selectedFiles.length < 3) {
            imageCount.parentElement.classList.add('text-danger');
            imageCount.parentElement.classList.remove('text-success');
        } else {
            imageCount.parentElement.classList.add('text-success');
            imageCount.parentElement.classList.remove('text-danger');
        }
    }

    const categories = {{{categoriesJson}}};

    // Category cascade
    const parentSelect = document.getElementById('parentCategory');
    const subSelect = document.getElementById('subCategory');

    parentSelect.addEventListener('change', function () {
      const parentId = this.value;

      // reset sub
      subSelect.innerHTML = '<option value="">-- Chọn con --</option>';

      if (!parentId) return;

      const parent = categories.find(c => c.id == parentId);
      if (!parent || !parent.subCategories) return;

      parent.subCategories.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub.id;
        opt.textContent = sub.cat_name;
        subSelect.appendChild(opt);
      });
      });
</script>

{{/section}}